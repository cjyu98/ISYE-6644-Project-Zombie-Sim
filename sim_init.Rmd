---
title: "ISYE 6644 - Project"
output: html_notebook
---
Code intended for mostly exploring Epimodel as a package/capabilities

# Original Example
Initial code pulled from: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5931789/
from Example 1

```{r init, warning=FALSE, message=FALSE}
# clear environment
rm(list=ls())

# libraries
library(EpiModel)
```


```{r}
set.seed(12345)
#SIS sample model

nw <- network::network.initialize(n = 1000, directed = FALSE) # n is number of nodes
nw <- network::set.vertex.attribute(nw, "risk", rep(0:1, each = 500))
formation <- ~edges + nodefactor("risk") + nodematch("risk") + concurrent
target.stats <- c(250, 375, 225, 100)
coef.diss <- dissolution_coefs(dissolution = ~ offset(edges), duration = 80)
coef.diss

```
```{r}
est1 <- netest(nw, formation, target.stats, coef.diss)
dx <- netdx(est1, nsims = 10, nsteps = 1000)
dx
```

```{r}
init <- init.net(i.num = 50)
param <- param.net(inf.prob = 0.1, act.rate = 5, rec.rate = 0.02)
control <- control.net(type = "SIS", nsteps = 500, nsims = 10, epi.by = "risk")
sim1 <- netsim(est1, param, init, control)
```

```{r}
summary(sim1, 500)
```
Code pulled from: https://epimodel.github.io/epimodel-training/basics_of_network_models/sis_basics.html and https://epimodel.github.io/epimodel-training/network_models_with_feedback/vaccine_intervention.html

# Main SIR model

Adjusted for an SIR model, added in inter.eff & inter.start for intervention

```{r model setup and parameterization}
# network set up, have two groups for different risks
n = 500 # number of people
nw <- network_initialize(n = n) 
nw <- set_vertex_attribute(nw, attrname = "risk", value = rep(0:1, each = 250)) 
formation <- ~edges + nodefactor("risk") + nodematch("risk") + concurrent
#nodefactor: likelihood of node forming an edge
#nodematch: tendency to for nodes of similar attributes to form an edge
#concurrent: # having at least "two partners"/two connected nodes at any time, can constraint with degrange()

# mean degree values (all needs to be tuned/decide on what makes logical sense)
overall_mean_deg = 0.5
gr1_mean_deg = 0.75
perc_in_grp = 0.8 # percentage of partnerships that occur from people within same risk group 
perc_concurrent = 0.1 # percentage of concurrent nodes out of the total
# write in the same order of formation formula, the concurrent # needs to be tuned
target.stats <- c(overall_mean_deg*n/2, gr1_mean_deg*n/2, perc_in_grp*n/4, perc_concurrent*n) 
coef.diss <- dissolution_coefs(dissolution = ~offset(edges), duration = 5)
# need to adjust duration for when edges dissolve 
coef.diss
est <- netest(nw, formation, target.stats, coef.diss) #estimate coefficients of the network

```
```{r model diagnostics}
dx <- netdx(est, nsims = 10, nsteps = 1000, ncores = 5,
            nwstats.formula = ~edges + meandeg + degree(0:4, by = "risk") + concurrent) # we'll see how many have up to 4 degrees, can adjust number
plot(dx)
print(dx)
```

https://statnet.org/nme/d4-s3-Demography.html for mortality rate inclusion


```{r model simulation}
start <- Sys.time()

param <- param.net(inf.prob = 0.5, inf.prob.g1 = 0.75,
                   inter.eff = abs(rnorm(1)), inter.start = abs(rnorm(1, mean = 250, sd = 20)), # cure, distributions to be tuned, rnorms could be negative....
                   rec.rate = 0.002, rec.rate.g1 = 0.001) # recovery rate with immunity


#infection probability, efficacy of intervention, when does it intervene

init <- init.net(i.num = 5, r.num = 0) #how many people are infected/recovered at the start
control <- control.net(type = "SIR", nsteps = 500, nsims = 10, ncores = 5) #simulation parameters
sim <- netsim(est, param, init, control) #run the sim
plot(sim)
end <- Sys.time()
end - start

```

